from django.shortcuts import render, redirectfrom django.http import HttpResponsefrom django.utils import timezonefrom django.db import connectionfrom .forms import CQHEISurveyFormfrom .models import CQHEISurveyimport csvimport timedef survey_form(request):    section2_score = None    if request.method == 'POST':        form = CQHEISurveyForm(request.POST)        if form.is_valid():            # Save main survey (EXISTING behavior)            survey = form.save()            # ============================            # Section II – Fish Cover            # ============================            now = timezone.now()            with connection.cursor() as cursor:                cursor.execute("""                    INSERT INTO cQHEI.Cover (                        cQHEI_New_X_ID,                        Underwater_Tree_Roots,                        Underwater_Tree_Rootlets,                        Boulders,                        Oxbows_Backwaters,                        Downed_trees,                        Shallows,                        Water_Plants,                        Deep_Pools,                        Overhanging_Vegetation,                        Undercut_Banks,                        Created_Timestamp,                        Last_Updated_Timestamp                    )                    OUTPUT INSERTED.Cover_Score                    VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)                """, [                    survey.id,                    2 if form.cleaned_data.get('cover_underwater_tree_roots_large') else 0,                    2 if form.cleaned_data.get('cover_underwater_tree_rootlets') else 0,                    2 if form.cleaned_data.get('cover_boulders') else 0,                    2 if form.cleaned_data.get('cover_backwaters') else 0,                    2 if form.cleaned_data.get('cover_downed_trees') else 0,                    2 if form.cleaned_data.get('cover_shallow_slow_areas') else 0,                    2 if form.cleaned_data.get('cover_water_plants') else 0,                    2 if form.cleaned_data.get('cover_deep_areas') else 0,                    2 if form.cleaned_data.get('cover_shrubs_small_trees') else 0,                    2 if form.cleaned_data.get('cover_undercut_banks') else 0,                    now,                    now                ])                section2_score = cursor.fetchone()[0]            return render(                request,                'survey_form.html',                {                    'form': CQHEISurveyForm(),                    'section2_score': section2_score                }            )    else:        form = CQHEISurveyForm()    return render(        request,        'survey_form.html',        {            'form': form,            'section2_score': section2_score        }    )# ✅ THIS WAS MISSING / BROKEN — REQUIRED BY urls.pydef survey_success(request, survey_id):    try:        survey = CQHEISurvey.objects.get(id=survey_id)        return render(request, 'success.html', {'survey': survey})    except CQHEISurvey.DoesNotExist:        return HttpResponse("Survey not found")def survey_list(request):    surveys = CQHEISurvey.objects.all().order_by('-survey_date')    return render(request, 'survey_list.html', {'surveys': surveys})def export_surveys_csv(request):    response = HttpResponse(content_type='text/csv')    response['Content-Disposition'] = 'attachment; filename="cqhei_surveys.csv"'    writer = csv.writer(response)    writer.writerow(['ID', 'Date', 'River Site', 'River Code', 'River Mile', 'Name/Group'])    surveys = CQHEISurvey.objects.all().order_by('-survey_date')    for survey in surveys:        writer.writerow([            survey.id,            survey.survey_date,            survey.river_site,            survey.river_code,            survey.river_mile,            survey.name_group        ])    return response